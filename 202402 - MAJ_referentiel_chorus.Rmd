---
title: "Historique_referentiels"
output: html_document
author: "Marie"
date: "2024-02-28"
editor_options: 
  markdown: 
    wrap: 72
---

Ce document a pour but de mettre à jour les référentiels extraits de la
calculette shogun grâce aux fichiers déposés sur Resana par la DRFIP.

# Environnement de travail

```{r}
library(aws.s3)
#install.packages("readxl")
library(readxl)
#install.packages("readODS")
library(readODS)
library(dplyr)
library(stringr)
library(dplyr)
```

# 1. Programmes

## 1.1. Importation des données

### Calculette shogun

```{r}
BUCKET <- "marieguibert2"
FILE_KEY_S3 <- "202402 - MAJ Référentiels/Calculette_Chorus_2024-02-27.xlsx"

shogun_prog <- 
  aws.s3::s3read_using(
    FUN = readxl::read_excel, 
    sheet = "03 - Programmes",
    skip = 8,
    object = FILE_KEY_S3,
    bucket = BUCKET,
    opts = list("region" = "")
  )

head(shogun_prog)
```

```{r}
dim(shogun_prog)
```

On dispose de 352 programmes pour la calculette de shogun en date du
27/02/2024

On remarque un "problème" :

```{r}
length(unique(shogun_prog$`Code Programme`))
```

```{r}
length(unique(shogun_prog$Intitulé))
```

On a bien 352 id différents mais seulement 222 intitulés différents

### DRFIP

```{r}
FILE_KEY_S3 <- "202402 - MAJ Référentiels/Fichiers DRFIP/référentiel domaines fonctionnels 2024.ods"

prog_domaines_fonct <- 
  aws.s3::s3read_using(
    FUN = readODS::read_ods, 
    object = FILE_KEY_S3,
    bucket = BUCKET,
    opts = list("region" = "")
  )

head(prog_domaines_fonct)
```

On retravaille le fichier pour :

\- avoir les mêmes colonnes que dans la calculette shogun

\- renommer les colonnes pour avoir les mêmes noms

\- garder les lignes où le code est de longueur 4 pour n'avoir que les
programmes

```{r}
prog <- prog_domaines_fonct %>% 
  rename("Code Programme" = "Domaine fonctionnel",
         "Intitulé" = "Texte esp. fcts",
         "Date validité Début" = "Valide à partir du",
         "Date validité Fin" = "Fin de validité") %>% 
  filter(!str_detect(`Code Programme`, "-"))

head(prog)
```

```{r}
dim(prog)
```

Suite à ces traitements, on obtient 370 programmes pour le fichier de la
DRFIP

```{r}
length(unique(prog$Intitulé))
```

On a 345 noms de programmes différents, cela va nous permettre de
compléter ceux qui se trouvent dans la calculette shogun

## 1.2. Comparaison des deux fichiers

On compare d'abord les noms de colonnes pour être sur qu'ils se
correspondent bien.

```{r}
cat("Noms de colonnes shogun : ", paste0(colnames(shogun_prog), collapse = "/"))
cat('\n')
cat("Noms de colonnes  DRFIP :",paste0(colnames(prog), collapse = "/"))
```

On réalise une jointure pour récupérer les programmes de shogun et ceux
de la drfip

-   On se base sur le code du programme pour la fusion

-   On conserve toutes les lignes du fichier shogun et toutes les lignes
    du fichier de la drfip

-   Pour voir quel Intitulé de programme garder, on ajoute des suffixes

```{r}
comp_prog <- merge(shogun_prog, prog, 
                   by = c("Code Programme"), 
                   all.x = T, all.y = T, 
                   suffixes = c('_shogun','_drfip'))
```

Modification des dates :

-   On ne garde pas la date de début de shogun car elle contient moins
    d'historique que celle de la drfip
-   On ne garde pas la date de fin de la drfip car elle est moins
    souvent actualisée

```{r}
comp_prog <- comp_prog %>% 
  select(-`Date validité Début_shogun`,  # suppression des colonnes
         -`Date validité Fin_drfip`) %>% 
  rename("Date validité Début" = "Date validité Début_drfip" ,  # renommage pour correspondre au fichier attendu
         "Date validité Fin" = "Date validité Fin_shogun")

head(comp_prog)
```

On fusionne les colonnes Intitulé_drfip avec Intitulé_shogun pour
obtenir une seule colonne **Intitulé**

Règle :

\- Par défaut on prend l'intitulé de shogun car il est plus complet \
- Si le nom est dupliqué pour l'intitulé shogun alors la première fois
on prend clui de shogun sinon on prend celui de la drfip \
- Si le nom n'est pas renseigné dans shogun alors on prend celui de la
DRFIP

```{r}
# Identifier les lignes avec des Intitulé_chorus répétées
duplicated_rows <- duplicated(comp_prog$Intitulé_shogun)

# Modifier la colonne Intitulé en fonction des conditions
comp_prog$Intitulé <- ifelse(duplicated_rows, comp_prog$Intitulé_drfip, comp_prog$Intitulé_shogun)

# Supprimer les colonnes devenues redondantes si nécessaire
comp_prog$Intitulé_shogun <- NULL
comp_prog$Intitulé_drfip <- NULL
```

## 1.3. Conclusion

```{r}
head(comp_prog)
```

```{r}
dim(comp_prog)
```

On obtient 412 programmes au final (avec 352 au départ pour shogun)

```{r}
length(unique(comp_prog$Intitulé))
```

On obtient 348 noms différents, ce qui parait cohérent par rapport au
départ

## 1.4. Export du fichier actualisé

```{r}
# BUCKET_OUT = "marieguibert2"
# FILE_KEY_OUT_S3 = "202402 - MAJ Référentiels/Fichiers traités/programmes_actualises.csv"
# 
# aws.s3::s3write_using(
#     comp_prog,
#     FUN = write.csv,
#     object = FILE_KEY_OUT_S3,
#     bucket = BUCKET_OUT,
#     opts = list("region" = "")
# )
```

# 2. Domaines fonctionnels

## 2.1. Importation des données

### Calculette shogun

```{r}
FILE_KEY_S3 <- "202402 - MAJ Référentiels/Calculette_Chorus_2024-02-27.xlsx"

shogun_domaines_fonct <- 
  aws.s3::s3read_using(
    FUN = readxl::read_excel, 
    sheet = "07 - Domaines Fonct. (DF)",
    skip = 8,
    object = FILE_KEY_S3,
    bucket = BUCKET,
    opts = list("region" = "")
  )
```

On renomme les colonnes pour savoir à quels codes les colonnes
correspondent

```{r}
shogun_domaines_fonct <- shogun_domaines_fonct %>% 
  rename("Code_min" = "Code...1", 
         "Code_prog" = "Code...3", 
         "Code" = "Code...5")
head(shogun_domaines_fonct)
```

```{r}
dim(shogun_domaines_fonct)
```

On a 2983 domaines fonctionnels dans la calculette shogun

### DRFIP

Le fichier a déjà été importé dans la section "Programmes"

-   Nous allons récupérer les domaines fonctionnels : les codes
    contenant un tiret
-   On renomme les colonnes pour avoir les mêmes noms

```{r}
domaines_fonct <- prog_domaines_fonct %>% 
  rename("Code" = "Domaine fonctionnel",
         "Intitulé" = "Texte esp. fcts",
         "Début" = "Valide à partir du",
         "Fin" = "Fin de validité") %>% 
  filter(str_detect(Code, "-"))
```

```{r}
head(domaines_fonct)
```

```{r}
dim(domaines_fonct)
```

On a 5310 domaines fonctionnels dans le fichier de la drfip

## 2.2. Comparaison des deux fichiers

On compare d'abord les noms de colonnes pour être sur qu'ils se
correspondent bien.

```{r}
cat("Noms de colonnes shogun : ", paste0(colnames(shogun_domaines_fonct), collapse = "/"))
cat('\n')
cat("Noms de colonnes  DRFIP :",paste0(colnames(domaines_fonct), collapse = "/"))
```

On fusionne les deux fichiers en se basant sur la colonne Code (Code du
domaine fonctionnel)

```{r}
comp_domaines_fonct <- merge(shogun_domaines_fonct, domaines_fonct, 
                             by = "Code", 
                             all.x = T, all.y = T, 
                             suffixes = c("_shogun", "_drfip"))
```

Modification des dates :

-   On ne garde pas la date de début de shogun car elle contient moins
    d'historique que celle de la drfip
-   On ne garde pas la date de fin de la drfip car elle est moins
    souvent actualisée

```{r}
comp_domaines_fonct <- comp_domaines_fonct %>% 
  select(-Début_shogun,  # suppression des colonnes
         -Fin_drfip) %>% 
  rename("Début" = "Début_drfip" ,  # renommage pour correspondre au fichier attendu
         "Fin" = "Fin_shogun")

head(comp_domaines_fonct)
```

On fusionne les colonnes Intitulé_drfip avec Intitulé_shogun pour
obtenir une seule colonne Intitulé

Règle : - Par défaut on prend l'intitulé de shogun car il est plus
complet - Si le nom est dupliqué pour l'intitulé shogun alors la
première fois on prend clui de shogun sinon on prend celui de la drfip -
Si le nom n'est pas renseigné dans shogun alors on prend celui de la
DRFIP

```{r}
# Identifier les lignes avec des Intitulé_chorus répétées
duplicated_rows <- duplicated(comp_prog$Intitulé_shogun)

# Modifier la colonne Intitulé en fonction des conditions
comp_prog$Intitulé <- ifelse(duplicated_rows, comp_prog$Intitulé_drfip, comp_prog$Intitulé_shogun)

# Supprimer les colonnes devenues redondantes si nécessaire
comp_prog$Intitulé_shogun <- NULL
comp_prog$Intitulé_drfip <- NULL
```

```{r}
# Sélection des lignes où Intitulé_shogun est dupliqué
resultat <- comp_prog[duplicated(comp_prog$Intitulé_shogun), ]

# Affichage du résultat
print(resultat)
```

## 2.3. Conclusion

```{r}
dim(comp_domaines_fonct)
```

## 2.4. Export du fichier actualisé

# 3. Référentiels de programmation

## 3.1. Importation des données

## 3.2. Comparaison des deux fichiers

## 3.3. Conclusion

## 3.4. Export du fichier actualisé

# 4. Centres de coûts

## 4.1. Importation des données

## 4.2. Comparaison des deux fichiers

## 4.3. Conclusion

## 4.4. Export du fichier actualisé
